@startuml W-Pre-market AMM System

' Define participants
actor "LP Provider" as LPProvider
actor "Trader" as Trader
participant "W-Pre-market AMM" as AMM
database "Liquidity Pool" as Pool
participant "Price Calculator" as Calculator
participant "Token Minter" as Minter

' Style
skinparam sequence {
    ParticipantBackgroundColor LightBlue
    ActorBackgroundColor LightGreen
    DatabaseBackgroundColor LightPink
    LifeLineColor Gray
    BorderColor Black
}

' Define mathematical formulas as notes
note left of LPProvider
  <b>Key Formulas:</b>
  
  <b>Thanh khoản (Liquidity):</b>
  L = x / (1/√Pa - 1/√Pb)
  
  <b>Tại giá P:</b>
  x = L · (1/√P - 1/√Pb)
  y = L · (√P - √Pa)
  
  <b>Công thức tổng quát:</b>
  y = x · (√Pb - √Pa) / (1/√Pa - 1/√Pb)
end note

' LP Provider Flow
group LP Provider Adds Liquidity
    LPProvider -> AMM: Add Liquidity (x base token, Pa, Pb)
    activate AMM
    
    AMM -> Calculator: Calculate liquidity parameters
    activate Calculator
    
    Calculator -> Calculator: Calculate L = x / (1/√Pa - 1/√Pb)
    Calculator -> Calculator: Calculate y = x · (√Pb - √Pa) / (1/√Pa - 1/√Pb)
    Calculator --> AMM: Return y (amount of w-pre-token needed)
    deactivate Calculator
    
    AMM -> Minter: Request to mint y w-pre-tokens
    activate Minter
    Minter --> AMM: Return newly minted w-pre-tokens
    deactivate Minter
    
    AMM -> Pool: Add x base tokens + y w-pre-tokens to pool
    AMM --> LPProvider: Issue LP tokens representing share of pool
    
    deactivate AMM
end

' Trader Flow - Buy w-pre-tokens
group Trader Buys w-pre-tokens
    Trader -> AMM: Buy w-pre-tokens with x base tokens
    activate AMM
    
    AMM -> Calculator: Calculate output amount
    activate Calculator
    
    Calculator -> Calculator: Calculate current price based on pool ratio
    Calculator -> Calculator: Calculate output w-pre-tokens based on formula
    Calculator --> AMM: Return output amount of w-pre-tokens
    deactivate Calculator
    
    AMM -> Pool: Remove base tokens and w-pre-tokens according to formula
    AMM --> Trader: Send w-pre-tokens to trader
    
    deactivate AMM
end

' Trader Flow - Sell w-pre-tokens
group Trader Sells w-pre-tokens
    Trader -> AMM: Sell y w-pre-tokens
    activate AMM
    
    AMM -> Calculator: Calculate output amount
    activate Calculator
    
    Calculator -> Calculator: Calculate current price based on pool ratio
    Calculator -> Calculator: Calculate output base tokens based on formula
    Calculator --> AMM: Return output amount of base tokens
    deactivate Calculator
    
    AMM -> Pool: Remove base tokens and w-pre-tokens according to formula
    AMM --> Trader: Send base tokens to trader
    
    deactivate AMM
end

' Add notes
note over AMM: Automated Market Maker for pre-market tokens
note over Pool: Contains base tokens (ETH, USDC, etc.) and w-pre-tokens
note over Calculator: Implements the bonding curve formulas
note over Minter: Creates new w-pre-tokens when liquidity is added
note over LPProvider: Provides liquidity with base tokens and price range (Pa to Pb)
note over Trader: Trades base tokens for w-pre-tokens or vice versa

@enduml 